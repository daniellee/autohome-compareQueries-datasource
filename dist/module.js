define(["lodash","moment","app/plugins/sdk"],(function(t,e,r){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)r.d(n,i,function(e){return t[e]}.bind(null,i));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/",r(r.s=3)}([function(e,r){e.exports=t},function(t,r){t.exports=e},function(t,e){t.exports=r},function(t,e,r){"use strict";r.r(e);var n=r(0),i=r.n(n),o=r(1),a=r.n(o),u=function(){function t(t,e,r){this.units=["y","M","w","d","h","m","s"],this.datasourceSrv=e,this.$q=t,this.templateSrv=r}return t.$inject=["$q","datasourceSrv","templateSrv"],t.prototype.testDatasource=function(){return new Promise((function(t,e){t({status:"success",message:"Compare Query Source is working correctly",title:"Success"})}))},t.prototype.query=function(t){var e=this,r=i.a.groupBy(t.targets,"datasource"),n=i.a.groupBy(t.targets,"refId"),o=[];return i.a.forEach(r,(function(r,a){var u=i.a.cloneDeep(t),f=e.datasourceSrv.get(a).then((function(i){if(i.meta.id===e.meta.id)return e._compareQuery(t,r,n,e);u.targets=r;var o=i.query(u);return"function"==typeof o.toPromise?o.toPromise():o}));o.push(f)})),this.$q.all(o).then((function(t){return{data:i.a.flatten(i.a.filter(i.a.map(t,(function(t){var e=t.data;return e&&(e=i.a.filter(t.data,(function(t){return!0!==t.hide}))),e})),(function(t){return null!=t})))}}))},t.prototype._compareQuery=function(t,e,r,n){var o=[];return i.a.forEach(e,(function(e){var a=e.query;if(null!==a&&""!==a&&null!==r[a]){var u=i.a.cloneDeep(r[a][0]);if(u.hide=!1,u){var f=u.datasource;e.timeShifts&&e.timeShifts.length>0&&i.a.forEach(e.timeShifts,(function(r){var a,s,c=n.datasourceSrv.get(f).then((function(e){if(e.meta.id===n.meta.id)return{data:[]};if(a=n.templateSrv.replace(r.value,t.scopedVars),s=n.templateSrv.replace(r.alias,t.scopedVars)||a,null===a||""===a||void 0===a)return{data:[]};var o=i.a.cloneDeep(t);o.range.from=n.addTimeShift(o.range.from,a),o.range.to=n.addTimeShift(o.range.to,a),o.range.raw={from:o.range.from,to:o.range.to},o.rangeRaw=o.range.raw,u.refId=u.refId+"_"+a,o.targets=[u],o.requestId=o.requestId+"_"+a;var f=e.query(o);return"function"==typeof f.toPromise?f.toPromise():f})).then((function(t){var r=t.data;return r.forEach((function(t){if(t.target?(t.target=t.target+"_"+s,void 0!==t.title&&null!==t.title&&(t.title=t.title+"_"+s)):t.fields&&(t.name=t.name+"_"+s),e.process){var r=n.parseShiftToMs(a);"table"===t.type?t.rows&&t.rows.forEach((function(t){t[0]=t[0]+r})):t.datapoints&&t.datapoints.forEach((function(t){t[1]=t[1]+r}))}t.hide=e.hide})),{data:r}}));o.push(c)}))}}})),this.$q.all(o).then((function(t){return{data:i.a.flatten(i.a.filter(i.a.map(t,(function(t){var e=t.data;return e&&(e=i.a.filter(t.data,(function(t){return!0!==t.hide}))),e})),(function(t){return null!=t})))}}))},t.prototype.parseShiftToMs=function(t){var e=this.parseTimeShift(t);if(e){var r=0-e.num,n=e.unit;if(i.a.includes(this.units,n)){var o=a()(),u=o.clone().add(r,n);return o.valueOf()-u.valueOf()}}},t.prototype.parseTimeShift=function(t){for(var e=t,r=t.length,n=0;n<r&&!isNaN(e.charAt(n));)if(++n>10)return;return{num:parseInt(e.substring(0,n),10),unit:e.charAt(n)}},t.prototype.addTimeShift=function(t,e){var r=this.parseTimeShift(e);if(r){var n=0-r.num,o=r.unit;return i.a.includes(this.units,o)?t.clone().add(n,o):void 0}},t}(),f=function(t,e){return(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};var s=function(t){function e(e,r){var n=t.call(this,e,r)||this;return n.target.timeShifts||(n.target.timeShifts=[]),0===n.target.timeShifts.length&&n.addTimeShifts(),void 0===n.target.process&&(n.target.process=!0),n}return e.$inject=["$scope","$injector"],function(t,e){function r(){this.constructor=t}f(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.targetBlur=function(){this.refresh()},e.prototype.onChangeInternal=function(){this.refresh()},e.prototype.addTimeShifts=function(){var t=this.getTimeShiftId();this.target.timeShifts.push({id:t})},e.prototype.removeTimeShift=function(t){if(!(this.target.timeShifts&&this.target.timeShifts.length<=1)){var e=i.a.indexOf(this.target.timeShifts,t);this.target.timeShifts.splice(e,1),this.refreshTimeShifts()}},e.prototype.refreshTimeShifts=function(){this.refresh()},e.prototype.getTimeShiftId=function(){for(var t=0;;){if(i.a.every(this.target.timeShifts,(function(e){return e.id!==t})))return t;t++}},e.templateUrl="partials/query.editor.html",e}(r(2).QueryCtrl),c=function(){function t(){}return t.templateUrl="partials/config.html",t}();r.d(e,"Datasource",(function(){return u})),r.d(e,"QueryCtrl",(function(){return s})),r.d(e,"ConfigCtrl",(function(){return c}))}])}));
//# sourceMappingURL=module.js.map